<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz Admin Dashboard</title>
  <link rel="icon" href="quiz.png" type="image/png">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Chart.js v3.9.1 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- Firebase (core + realtime database) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <style>
    :root {
      --color-background: #F9F7F7;
      --color-secondary: #DBE2EF;
      --color-primary: #3F72AF;
      --color-dark: #112D4E;
      --color-white: #FFFFFF;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background-color: var(--color-background);
      color: var(--color-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    header {
      width: 100%;
      background-color: var(--color-primary);
      padding: 20px 0;
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      color: var(--color-white);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: fixed;
      top: 0; left: 0;
      z-index: 1000;
    }
    .container {
      background-color: var(--color-white);
      padding: 80px 40px 40px; /* Enough top padding for the fixed header */
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 1600px;
      margin-top: 20px;
      margin-bottom: 40px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 2em;
      color: var(--color-primary);
    }

    /* Grade & Filter Sections */
    .grade-selection {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .grade-selection label {
      font-size: 1.2em;
      margin-right: 10px;
    }
    .search-filter {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-filter input,
    .search-filter select {
      padding: 10px;
      border: 2px solid var(--color-secondary);
      border-radius: 8px;
      font-size: 1em;
      margin: 5px 0;
      flex: 1 1 200px;
      margin-right: 10px;
    }
    .button {
      background-color: var(--color-primary);
      color: var(--color-white);
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease, transform 0.2s ease;
      margin-right: 10px;
      flex: 1 1 150px;
      margin-top: 5px;
    }
    .button:hover {
      background-color: #2c5aa0;
      transform: translateY(-2px);
    }

    /* Results Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid var(--color-secondary);
      text-align: left;
    }
    th {
      background-color: var(--color-primary);
      color: var(--color-white);
      cursor: pointer;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    /* Student Responses */
    #student-responses {
      display: none;
      margin-top: 40px;
    }
    #student-responses h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 2em;
      color: var(--color-primary);
    }
    #responses-table {
      width: 100%;
      border-collapse: collapse;
    }
    #responses-table th, #responses-table td {
      padding: 12px 15px;
      border: 1px solid var(--color-secondary);
      text-align: left;
    }
    #responses-table th {
      background-color: var(--color-primary);
      color: var(--color-white);
    }
    #responses-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    /* Horizontal scroll container for summary charts */
    .summary-charts {
      display: flex;
      flex-wrap: nowrap;       /* single row, scroll horizontally */
      overflow-x: auto;
      gap: 20px;
      margin-bottom: 40px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 20px;
      justify-content: center;
    }
    .summary-chart-box {
      flex: 0 0 auto;          /* do not shrink below 450px */
      background-color: var(--color-white);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;

      /* Limit container height & allow internal scroll if legend is big */
      max-height: 420px;
      overflow-y: auto;
    }
    .summary-chart-box h4 {
      margin: 0 0 10px;
      font-size: 1rem;
      color: var(--color-dark);
      text-align: center;
    }
    .summary-chart-box canvas {
      width: 100% !important;
      /* limit canvas so it won't expand container infinitely */
      max-height: 300px !important;
    }

    /* Horizontal scroll container for per-question charts */
    .response-charts {
      display: flex;
      flex-wrap: wrap;      
      overflow-y: auto;
      gap: 20px;
    }
    .response-card {
        width: 45%;
      flex: 0 0 auto;
      background-color: var(--color-white);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;

      /* Limit container height & allow internal scroll if needed */
      max-height: 420px;
      overflow-y: auto;
    }
    .response-card h4 {
      margin: 0 0 10px;
      font-size: 1rem;
      color: var(--color-dark);
      text-align: center;
    }
    .response-card canvas {
      width: 100% !important;
      max-height: 300px !important;
    }

    /* Print Styles */
    @media print {
      header {
        position: static;
        box-shadow: none;
      }
      .container {
        box-shadow: none;
        padding: 20px;
      }
      .button, .search-filter, .grade-selection {
        display: none;
      }
      .summary-charts, .response-charts {
        flex-wrap: wrap !important;  /* print all in multiple rows */
      }
      .summary-chart-box, .response-card {
        max-height: 100% !important; /* no internal scroll on print */
        overflow-y: visible !important;
        width: 500px !important;
      }
      .summary-chart-box canvas,
      .response-card canvas {
        max-height: none !important;
      }
    }

    /* Additional responsive tweaks */
    @media (max-width: 768px) {
      .search-filter {
        flex-direction: column;
        align-items: stretch;
      }
      .search-filter input,
      .search-filter select {
        width: 100%;
        margin-right: 0;
      }
      .button {
        flex: 1 1 100%;
      }
      /* let chart boxes be narrower on small screens */
      .summary-chart-box, .response-card {
        min-width: 320px;
      }
    }
  </style>
</head>
<body>
  <header>Quiz Admin Dashboard</header>

  <div class="container">
    <h2>All Quiz Results</h2>
    
    <!-- Grade Selection -->
    <div class="grade-selection">
      <label for="grade-select">Select Grade:</label>
      <select id="grade-select" onchange="fetchData()">
        <option value="grade3">Grade 3</option>
        <option value="grade4">Grade 4</option>
      </select>
    </div>
    
    <!-- Search & Filter -->
    <div class="search-filter">
      <input type="text" id="student-search" placeholder="Search by Name, Division, or Roll Number" onkeyup="filterTable()" />
      <select id="division-filter" onchange="filterTable()">
        <option value="">All Divisions</option>
        <option value="A">Division A</option>
        <option value="B">Division B</option>
      </select>
      
      <button class="button" onclick="downloadSummaryCSV()">Download Summary CSV</button>
      <button class="button" onclick="downloadDetailedCSV()">Download Detailed CSV</button>
      <button class="button" onclick="fetchData()">Refresh Data</button>
    </div>

    <!-- Results Table -->
    <table id="results-table">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Name &#x25B2;&#x25BC;</th>
          <th onclick="sortTable(1)">Division &#x25B2;&#x25BC;</th>
          <th onclick="sortTable(2)">Roll Number &#x25B2;&#x25BC;</th>
          <th onclick="sortTable(3)">Score &#x25B2;&#x25BC;</th>
          <th onclick="sortTable(4)">Total Questions &#x25B2;&#x25BC;</th>
          <th onclick="sortTable(5)">Timestamp &#x25B2;&#x25BC;</th>
          <th>View Responses</th>
        </tr>
      </thead>
      <tbody>
        <!-- Populated dynamically -->
      </tbody>
    </table>

    <!-- Student Responses -->
    <div id="student-responses">
      <h2>Student Responses</h2>
      <table id="responses-table">
        <thead>
          <tr>
            <th>Question</th>
            <th>Selected Answer</th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated on "View" button click -->
        </tbody>
      </table>
    </div>
    
    <h2>Data Visualizations</h2>
    <!-- Horizontal scroll container for summary charts -->
    <div class="summary-charts">
      <div class="summary-chart-box">
        <h4>Score Distribution</h4>
        <canvas id="scoreDistributionChart"></canvas>
      </div>
      <div class="summary-chart-box">
        <h4>Average Score Per Division</h4>
        <canvas id="averageScorePerDivisionChart"></canvas>
      </div>
    </div>

    <h2>Response Distribution for All Questions</h2>
    <!-- Horizontal scroll container for question charts -->
    <div class="response-charts">
      <!-- Each question's chart is appended here dynamically -->
    </div>
  </div>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB-RDLOoTlaio0VgtFh7eencMr9ekdFEEk",
      authDomain: "test-app-1-6ade5.firebaseapp.com",
      databaseURL: "https://test-app-1-6ade5-default-rtdb.firebaseio.com",
      projectId: "test-app-1-6ade5",
      storageBucket: "test-app-1-6ade5.firebasestorage.app",
      messagingSenderId: "938447574937",
      appId: "1:938447574937:web:65c1c53a12c665988b2508",
      measurementId: "G-FKNLFZH4G9"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  <script>
    // Example question arrays (Grade 3 & Grade 4) ...
    const grade3Questions = [
      {
        "question": "What is a file?",
        "options": [
          "A) A tool to draw pictures",
          "B) A container for storing data",
          "C) A part of the keyboard",
          "D) A type of computer game"
        ],
        "correctAnswer": "B) A container for storing data",
        "explanation": "A file stores information such as text, pictures, or videos."
      },
      {
        "question": "What is the purpose of a folder?",
        "options": [
          "A) To group and organize files",
          "B) To play music",
          "C) To open the internet",
          "D) To write stories"
        ],
        "correctAnswer": "A) To group and organize files",
        "explanation": "Folders help keep files organized like a school bag keeps your books in place."
      },
      {
        "question": "How can you create a new folder?",
        "options": [
          "A) By typing in a chat box",
          "B) By clicking 'New Folder' in the menu",
          "C) By turning off the computer",
          "D) By opening a website"
        ],
        "correctAnswer": "B) By clicking 'New Folder' in the menu",
        "explanation": "Most computers allow you to create folders through a right-click or menu option."
      },
      {
        "question": "Which of these can you store in a file?",
        "options": [
          "A) Ideas",
          "B) Paper",
          "C) Pictures",
          "D) Both C and A"
        ],
        "correctAnswer": "D) Both C and A",
        "explanation": "Files can store digital information like pictures, text, and more."
      },
      {
        "question": "To rename a file, you should:",
        "options": [
          "A) Right-click and select 'Rename'",
          "B) Delete it",
          "C) Open the internet",
          "D) Restart the computer"
        ],
        "correctAnswer": "A) Right-click and select 'Rename'",
        "explanation": "You can rename files by right-clicking and selecting the rename option."
      },
      {
        "question": "Which is a good name for a folder?",
        "options": [
          "A) 'Untitled Folder'",
          "B) 'My School Projects'",
          "C) 'asdfghjkl'",
          "D) '123456'"
        ],
        "correctAnswer": "B) 'My School Projects'",
        "explanation": "Descriptive names make it easier to find your folders later."
      },
      {
        "question": "What happens if you delete a file?",
        "options": [
          "A) It disappears forever",
          "B) It goes to the Recycle Bin",
          "C) It gets renamed",
          "D) Nothing happens"
        ],
        "correctAnswer": "B) It goes to the Recycle Bin",
        "explanation": "Deleted files usually go to the Recycle Bin and can be restored if needed."
      },
      {
        "question": "What is the Recycle Bin used for?",
        "options": [
          "A) Storing deleted files temporarily",
          "B) Organizing important files",
          "C) Browsing the internet",
          "D) Playing games"
        ],
        "correctAnswer": "A) Storing deleted files temporarily",
        "explanation": "The Recycle Bin keeps deleted files until they are permanently removed."
      },
      {
        "question": "How can you quickly find a file on your computer?",
        "options": [
          "A) By searching its name",
          "B) By turning off the computer",
          "C) By asking a friend",
          "D) By using the internet"
        ],
        "correctAnswer": "A) By searching its name",
        "explanation": "Using the search bar on your computer helps locate files quickly."
      },
      {
        "question": "What is OpenOffice Writer?",
        "options": [
          "A) A program for typing documents",
          "B) A program for drawing pictures",
          "C) A tool to browse the internet",
          "D) A type of computer game"
        ],
        "correctAnswer": "A) A program for typing documents",
        "explanation": "OpenOffice Writer is used for creating, editing, and saving documents."
      },
      {
        "question": "How do you open an existing document?",
        "options": [
          "A) By typing its name",
          "B) By clicking 'Open' in the File menu",
          "C) By restarting the computer",
          "D) By using the paint tool"
        ],
        "correctAnswer": "B) By clicking 'Open' in the File menu",
        "explanation": "The 'Open' option lets you access documents saved earlier."
      },
      {
        "question": "What is the underline button used for?",
        "options": [
          "A) To save a file",
          "B) To draw a line",
          "C) To put a line under the text",
          "D) To add pictures"
        ],
        "correctAnswer": "C) To put a line under the text",
        "explanation": "Underlining helps emphasize certain words or sentences."
      },
      {
        "question": "What does the 'Italic' button do?",
        "options": [
          "A) Makes text slanted",
          "B) Changes text to capital letters",
          "C) Erases the document",
          "D) Makes the text bold"
        ],
        "correctAnswer": "A) Makes text slanted",
        "explanation": "Italics are used to highlight words in a slanted font style."
      },
      {
        "question": "What is the shortcut to copy text?",
        "options": [
          "A) Ctrl + C",
          "B) Ctrl + V",
          "C) Ctrl + X",
          "D) Ctrl + P"
        ],
        "correctAnswer": "A) Ctrl + C",
        "explanation": "Ctrl + C copies the selected text so it can be pasted elsewhere."
      },
      {
        "question": "What is the internet?",
        "options": [
          "A) A type of computer",
          "B) A network connecting computers worldwide",
          "C) A program for typing documents",
          "D) A tool for drawing"
        ],
        "correctAnswer": "B) A network connecting computers worldwide",
        "explanation": "The internet connects computers to share information globally."
      },
      {
        "question": "Which of these is a use of the internet?",
        "options": [
          "A) Watching videos",
          "B) Browsing websites",
          "C) Sending emails",
          "D) All of the above"
        ],
        "correctAnswer": "D) All of the above",
        "explanation": "The internet can be used for many activities, including watching videos, browsing, and emailing."
      },
      {
        "question": "What is a browser?",
        "options": [
          "A) A tool to save files",
          "B) A program to access websites",
          "C) A type of file",
          "D) A painting tool"
        ],
        "correctAnswer": "B) A program to access websites",
        "explanation": "Browsers like Chrome and Firefox help you open websites."
      },
      {
        "question": "Which is a safe practice on the internet?",
        "options": [
          "A) Sharing your password with everyone",
          "B) Clicking on unknown links",
          "C) Keeping your personal information private",
          "D) Posting your address online"
        ],
        "correctAnswer": "C) Keeping your personal information private",
        "explanation": "Protecting personal information is important for staying safe online."
      },
      {
        "question": "What does 'www' stand for in a website address?",
        "options": [
          "A) World Wide Web",
          "B) Web World Wide",
          "C) World Wide Window",
          "D) Web Window World"
        ],
        "correctAnswer": "A) World Wide Web",
        "explanation": "WWW refers to the global system of interconnected web pages."
      },
      {
        "question": "What does 'refresh' do in a browser?",
        "options": [
          "A) Saves the page",
          "B) Reloads the page",
          "C) Closes the page",
          "D) Opens a new tab"
        ],
        "correctAnswer": "B) Reloads the page",
        "explanation": "Refreshing updates the content of a webpage."
      },
      {
        "question": "What is the purpose of a strong password?",
        "options": [
          "A) To confuse you",
          "B) To protect your account",
          "C) To share with others",
          "D) To log in faster"
        ],
        "correctAnswer": "B) To protect your account",
        "explanation": "Strong passwords make it harder for others to access your account."
      },
      {
        "question": "Why should you not share your password?",
        "options": [
          "A) It’s hard to remember",
          "B) It keeps your account secure",
          "C) It’s fun to share",
          "D) It helps others log in"
        ],
        "correctAnswer": "B) It keeps your account secure",
        "explanation": "Sharing passwords can compromise your account’s safety."
      },
      {
        "question": "Which of these is a search engine?",
        "options": [
          "A) Microsoft Word",
          "B) Google",
          "C) Paint",
          "D) Recycle Bin"
        ],
        "correctAnswer": "B) Google",
        "explanation": "Google is a popular search engine used worldwide."
      },
      {
        "question": "What does a search engine do?",
        "options": [
          "A) Prints documents",
          "B) Finds information online",
          "C) Organizes files",
          "D) Deletes text"
        ],
        "correctAnswer": "B) Finds information online",
        "explanation": "Search engines like Google help you find what you need online."
      },
      {
        "question": "How do you save a document?",
        "options": [
          "A) By clicking the save icon or pressing Ctrl + S",
          "B) By closing the document",
          "C) By printing it",
          "D) By restarting the computer"
        ],
        "correctAnswer": "A) By clicking the save icon or pressing Ctrl + S",
        "explanation": "Saving ensures your work is stored and can be accessed later."
      },
      {
        "question": "What does 'Ctrl + V' do?",
        "options": [
          "A) Copies text",
          "B) Cuts text",
          "C) Pastes copied text",
          "D) Saves a document"
        ],
        "correctAnswer": "C) Pastes copied text",
        "explanation": "Ctrl + V pastes the text that was previously copied or cut."
      },
      {
        "question": "What is a screenshot?",
        "options": [
          "A) A picture of your screen",
          "B) A video recording",
          "C) A type of file",
          "D) A drawing tool"
        ],
        "correctAnswer": "A) A picture of your screen",
        "explanation": "A screenshot captures exactly what is displayed on your screen."
      },
      {
        "question": "Which key is used to delete characters to the right of the cursor?",
        "options": [
          "A) Backspace",
          "B) Delete",
          "C) Enter",
          "D) Shift"
        ],
        "correctAnswer": "B) Delete",
        "explanation": "The Delete key removes characters to the right of the cursor."
      },
      {
        "question": "What does 'URL' stand for?",
        "options": [
          "A) Uniform Resource Locator",
          "B) Universal Resource Link",
          "C) United Resource Locator",
          "D) Uniform Reference Link"
        ],
        "correctAnswer": "A) Uniform Resource Locator",
        "explanation": "URL is the address used to access resources on the internet."
      },
      {
        "question": "What is an email?",
        "options": [
          "A) A type of file",
          "B) A message sent electronically",
          "C) A program",
          "D) A website"
        ],
        "correctAnswer": "B) A message sent electronically",
        "explanation": "Email allows you to send and receive messages over the internet."
      }
    ];
    const grade4Questions = [
      {
        "question": "What is the primary purpose of a bookmark in a browser?",
        "options": [
          "A) To save your favorite websites for quick access",
          "B) To speed up the browser",
          "C) To delete files",
          "D) To play online games"
        ],
        "correctAnswer": "A) To save your favorite websites for quick access",
        "explanation": "Bookmarks allow users to save and quickly access their favorite websites without having to search for them each time."
      },
      {
        "question": "Which of these is an example of a search engine?",
        "options": [
          "A) Google",
          "B) Microsoft Word",
          "C) OpenOffice Writer",
          "D) Adobe Reader"
        ],
        "correctAnswer": "A) Google",
        "explanation": "Google is a widely used search engine that helps users find information on the internet."
      },
      {
        "question": "What tool would you use to make text appear slanted?",
        "options": [
          "A) Bold",
          "B) Italic",
          "C) Underline",
          "D) Font Size"
        ],
        "correctAnswer": "B) Italic",
        "explanation": "The Italic tool slants the text to the right, often used for emphasis."
      },
      {
        "question": "What does Ctrl + Z do in a document?",
        "options": [
          "A) Undoes the last action",
          "B) Saves the document",
          "C) Deletes the document",
          "D) Copies text"
        ],
        "correctAnswer": "A) Undoes the last action",
        "explanation": "Ctrl + Z is a shortcut that reverses the most recent action performed in the document."
      },
      {
        "question": "What happens if you delete a file and then empty the Recycle Bin?",
        "options": [
          "A) The file is permanently deleted",
          "B) The file moves back to the desktop",
          "C) The file is saved automatically",
          "D) The file becomes hidden but not deleted"
        ],
        "correctAnswer": "A) The file is permanently deleted",
        "explanation": "Emptying the Recycle Bin removes all files it contains, making them unrecoverable through normal means."
      },
      {
        "question": "What is the purpose of rearranging icons on the desktop?",
        "options": [
          "A) To delete unnecessary files",
          "B) To organize files and programs for quick access",
          "C) To change the color of the desktop background",
          "D) To make the computer faster"
        ],
        "correctAnswer": "B) To organize files and programs for quick access",
        "explanation": "Organizing desktop icons helps users find and access their files and applications more efficiently."
      },
      {
        "question": "If a computer is slow even after restarting, which part might need an upgrade?",
        "options": [
          "A) Monitor",
          "B) RAM",
          "C) Speakers",
          "D) Keyboard"
        ],
        "correctAnswer": "B) RAM",
        "explanation": "RAM (Random Access Memory) affects a computer's ability to handle multiple tasks smoothly. Upgrading RAM can improve performance."
      },
      {
        "question": "What happens to the data stored in the hard drive when you shut down the computer?",
        "options": [
          "A) It gets deleted automatically",
          "B) It remains saved until you delete it manually",
          "C) It is moved to the RAM",
          "D) It is compressed into smaller files"
        ],
        "correctAnswer": "B) It remains saved until you delete it manually",
        "explanation": "Data on the hard drive is stored permanently and remains intact even when the computer is turned off."
      },
      {
        "question": "How does the computer use input and output devices?",
        "options": [
          "A) Input devices give commands; output devices show results",
          "B) Output devices store files; input devices display data",
          "C) Input devices connect to the internet; output devices save passwords",
          "D) Input devices turn on the computer; output devices restart it"
        ],
        "correctAnswer": "A) Input devices give commands; output devices show results",
        "explanation": "Input devices like keyboards and mice send data to the computer, while output devices like monitors and printers display the results."
      },
      {
        "question": "Which of these parts is used for temporary storage in a computer?",
        "options": [
          "A) CPU",
          "B) RAM",
          "C) Hard Drive",
          "D) Monitor"
        ],
        "correctAnswer": "B) RAM",
        "explanation": "RAM (Random Access Memory) provides temporary storage that the CPU uses to process data quickly."
      },
      {
        "question": "What does the Recycle Bin do?",
        "options": [
          "A) Permanently deletes files",
          "B) Stores deleted files temporarily",
          "C) Organizes documents",
          "D) Changes desktop settings"
        ],
        "correctAnswer": "B) Stores deleted files temporarily",
        "explanation": "The Recycle Bin holds deleted files until you choose to permanently remove them or restore them."
      },
      {
        "question": "Where is the Start button usually found?",
        "options": [
          "A) Top-right corner",
          "B) Bottom-left corner",
          "C) Middle of the screen",
          "D) Bottom-right corner"
        ],
        "correctAnswer": "B) Bottom-left corner",
        "explanation": "In most Windows operating systems, the Start button is located at the bottom-left corner of the screen."
      },
      {
        "question": "What does the ‘Auto-hide taskbar’ setting do?",
        "options": [
          "A) Locks the taskbar in place",
          "B) Makes the taskbar disappear until you move the mouse near it",
          "C) Hides the taskbar",
          "D) Deletes the taskbar icons"
        ],
        "correctAnswer": "B) Makes the taskbar disappear until you move the mouse near it",
        "explanation": "Auto-hide taskbar saves screen space by hiding the taskbar when not in use and revealing it when the cursor approaches."
      },
      {
        "question": "Which of these is NOT an input device?",
        "options": [
          "A) Mouse",
          "B) Keyboard",
          "C) Monitor",
          "D) Microphone"
        ],
        "correctAnswer": "C) Monitor",
        "explanation": "A monitor is an output device that displays information from the computer."
      },
      {
        "question": "Why is a hard drive important?",
        "options": [
          "A) It processes instructions",
          "B) It stores data for future use",
          "C) It connects to the internet",
          "D) It powers the computer"
        ],
        "correctAnswer": "B) It stores data for future use",
        "explanation": "The hard drive is responsible for storing all digital data, including the operating system, applications, and personal files."
      },
      {
        "question": "What happens to the data in the RAM when the computer is turned off?",
        "options": [
          "A) It is saved permanently",
          "B) It is lost",
          "C) It is stored in the hard drive",
          "D) It is transferred to the CPU"
        ],
        "correctAnswer": "B) It is lost",
        "explanation": "RAM is volatile memory, meaning all data stored in it is erased when the computer is turned off."
      },
      {
        "question": "Which device helps you move items on the screen?",
        "options": [
          "A) Monitor",
          "B) Mouse",
          "C) CPU",
          "D) Keyboard"
        ],
        "correctAnswer": "B) Mouse",
        "explanation": "A mouse is an input device that allows users to interact with the computer by moving a cursor on the screen."
      },
      {
        "question": "What is the main job of the CPU in a computer?",
        "options": [
          "A) Display pictures",
          "B) Store files",
          "C) Process instructions",
          "D) Connect to the internet"
        ],
        "correctAnswer": "C) Process instructions",
        "explanation": "The CPU (Central Processing Unit) executes instructions from programs, effectively acting as the brain of the computer."
      },
      {
        "question": "Which file format is most commonly used to save images from the internet?",
        "options": [
          "A) .txt",
          "B) .jpg",
          "C) .docx",
          "D) .exe"
        ],
        "correctAnswer": "B) .jpg",
        "explanation": ".jpg is a widely used format for saving and sharing images on the internet due to its efficient compression."
      },
      {
        "question": "Which of these statements about bookmarks is true?",
        "options": [
          "A) Bookmarks save your browsing history",
          "B) Bookmarks help you quickly access favorite websites",
          "C) Bookmarks delete unwanted files",
          "D) Bookmarks close open tabs"
        ],
        "correctAnswer": "B) Bookmarks help you quickly access favorite websites",
        "explanation": "Bookmarks allow users to save and easily return to their preferred websites without searching for them each time."
      },
      {
        "question": "What happens if you use the ‘Justify’ alignment option?",
        "options": [
          "A) Text is aligned to the left",
          "B) Text is aligned to the center",
          "C) Text is evenly spaced across the page",
          "D) Text is aligned to the right"
        ],
        "correctAnswer": "C) Text is evenly spaced across the page",
        "explanation": "The 'Justify' option aligns text to both the left and right margins, creating a clean and uniform appearance."
      },
      {
        "question": "Which of these devices helps you record sound into the computer?",
        "options": [
          "A) Speaker",
          "B) Microphone",
          "C) Webcam",
          "D) Mouse"
        ],
        "correctAnswer": "B) Microphone",
        "explanation": "A microphone is an input device that captures audio and sends it to the computer for processing or recording."
      },
      {
        "question": "Imagine you’re building a new computer. Which part would you focus on to make it run faster?",
        "options": [
          "A) RAM and CPU",
          "B) Monitor and Mouse",
          "C) Hard Drive and Keyboard",
          "D) Speakers and Printer"
        ],
        "correctAnswer": "A) RAM and CPU",
        "explanation": "Upgrading the RAM and CPU can significantly enhance a computer's processing speed and ability to handle multiple tasks."
      },
      {
        "question": "Why do laptops have smaller internal components compared to desktops?",
        "options": [
          "A) To reduce electricity use",
          "B) To make them portable and lightweight",
          "C) To store fewer files",
          "D) To improve their speed"
        ],
        "correctAnswer": "B) To make them portable and lightweight",
        "explanation": "Smaller components allow laptops to be compact and easy to carry, enhancing their portability."
      },
      {
        "question": "What does the \"Personalize\" option on the desktop allow you to do?",
        "options": [
          "A) Change the computer's speed",
          "B) Adjust the desktop’s appearance, like wallpaper and themes",
          "C) Add more memory to the computer",
          "D) Install new programs"
        ],
        "correctAnswer": "B) Adjust the desktop’s appearance, like wallpaper and themes",
        "explanation": "The 'Personalize' option lets users customize their desktop background, color schemes, and themes to their preference."
      },
      {
        "question": "What does locking the taskbar prevent?",
        "options": [
          "A) Closing open programs",
          "B) Changing the taskbar position accidentally",
          "C) Opening the Start menu",
          "D) Changing desktop shortcuts"
        ],
        "correctAnswer": "B) Changing the taskbar position accidentally",
        "explanation": "Locking the taskbar ensures it stays in place, preventing accidental movement or resizing."
      },
      {
        "question": "Why might someone use the \"Find and Replace\" tool?",
        "options": [
          "A) To quickly locate and change specific words or phrases",
          "B) To align text to the center",
          "C) To save the document",
          "D) To remove formatting from the text"
        ],
        "correctAnswer": "A) To quickly locate and change specific words or phrases",
        "explanation": "The 'Find and Replace' tool streamlines the process of editing documents by allowing users to search for specific text and replace it as needed."
      },
      {
        "question": "Which tab in a browser lets you see the list of websites you recently visited?",
        "options": [
          "A) History",
          "B) Bookmarks",
          "C) Refresh",
          "D) Settings"
        ],
        "correctAnswer": "A) History",
        "explanation": "The 'History' tab records and displays the websites a user has visited, allowing easy navigation back to them."
      },
      {
        "question": "Why is it important to update your web browser regularly?",
        "options": [
          "A) To improve security and add new features",
          "B) To delete old bookmarks",
          "C) To make the internet faster",
          "D) To automatically log into websites"
        ],
        "correctAnswer": "A) To improve security and add new features",
        "explanation": "Regular updates enhance browser security, fix bugs, and introduce new functionalities for a better user experience."
      },
      {
        "question": "Which of these is a good online practice?",
        "options": [
          "A) Using the same password for all accounts",
          "B) Avoiding suspicious links and pop-ups",
          "C) Sharing your password with a friend",
          "D) Entering personal details on all websites"
        ],
        "correctAnswer": "B) Avoiding suspicious links and pop-ups",
        "explanation": "Being cautious of suspicious links and pop-ups helps protect against malware, phishing, and other online threats."
      }
    ];

    let allResults = [];
    let currentGrade = 'grade3';

    let scoreDistributionChart = null;
    let averageScorePerDivisionChart = null;
    let responseDistributionCharts = [];

    async function fetchData() {
      try {
        const gradeSelect = document.getElementById('grade-select');
        currentGrade = gradeSelect.value;

        const dbRef = database.ref(`quiz-results/${currentGrade}/individual-results`);
        const snapshot = await dbRef.once('value');
        const data = snapshot.val() || {};

        console.log("Data fetched:", data);

        const tbody = document.querySelector('#results-table tbody');
        tbody.innerHTML = '';
        allResults = [];

        for (let key in data) {
          if (Object.prototype.hasOwnProperty.call(data, key)) {
            const entry = data[key];
            allResults.push(entry);

            const date = new Date(entry.timestamp);
            const formattedDate = date.toLocaleString();

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHtml(entry.name)}</td>
              <td>${escapeHtml(entry.division)}</td>
              <td>${escapeHtml(entry.rollNumber)}</td>
              <td>${entry.score}</td>
              <td>${entry.total}</td>
              <td>${formattedDate}</td>
              <td>
                <button class="button" onclick="viewResponses('${escapeQuotes(entry.name)}','${escapeQuotes(entry.rollNumber)}')">
                  View
                </button>
              </td>
            `;
            tbody.appendChild(row);
          }
        }
        if (allResults.length === 0) {
          alert("No quiz results found for this grade.");
        }
        
        // Build charts
        generateScoreDistributionChart(allResults);
        generateAverageScorePerDivisionChart(allResults);
        generateResponseDistributionChart(allResults);
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    }

    /* CSV Exports */
    function downloadSummaryCSV() {
      const rows = [];
      const table = document.getElementById('results-table');
      const headers = table.querySelectorAll('th');
      const headerText = Array.from(headers).slice(0, -1).map(h => `"${h.innerText.replace(/"/g,'""')}"`);
      rows.push(headerText.join(','));

      const tableRows = table.querySelectorAll('tbody tr');
      tableRows.forEach(r => {
        const cols = r.querySelectorAll('td');
        const rowData = Array.from(cols).slice(0, -1).map(c => `"${c.innerText.replace(/"/g,'""')}"`);
        rows.push(rowData.join(','));
      });

      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link= document.createElement('a');
      link.href= url;
      link.setAttribute('download',`quiz_summary_results_${currentGrade}.csv`);
      link.style.visibility='hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function downloadDetailedCSV() {
      const rows = [];
      const summaryHeaders = ["Name","Division","Roll Number","Score","Total Questions","Timestamp"];
      const questions = getQuestionsForCurrentGrade();
      const questionHeaders = questions.map(q => `"${q.question.replace(/"/g,'""')}"`);
      const allHeaders = [...summaryHeaders, ...questionHeaders];
      rows.push(allHeaders.join(','));

      allResults.forEach(entry => {
        const summaryData = [
          `"${entry.name.replace(/"/g,'""')}"`,
          `"${entry.division.replace(/"/g,'""')}"`,
          `"${entry.rollNumber.replace(/"/g,'""')}"`,
          entry.score,
          entry.total,
          `"${new Date(entry.timestamp).toLocaleString()}"`
        ];
        const responseData = questions.map(q => {
          const foundResp = entry.responses.find(r => r.question===q.question);
          return foundResp ? `"${foundResp.selectedAnswer.replace(/"/g,'""')}"` : `""`;
        });
        rows.push([...summaryData, ...responseData].join(','));
      });

      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
      const url= URL.createObjectURL(blob);
      const link= document.createElement('a');
      link.href= url;
      link.setAttribute('download',`quiz_detailed_results_${currentGrade}.csv`);
      link.style.visibility='hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    /* Escaping & Table Utils */
    function escapeHtml(text) {
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
      return text.replace(/[&<>"']/g, m=>map[m]);
    }
    function escapeQuotes(text) {
      return text.replace(/'/g,"\\'").replace(/"/g,'\\"');
    }

    /* Sorting & Filtering */
    let sortDirection={};
    function sortTable(colIndex) {
      const table= document.getElementById('results-table');
      const tbody= table.tBodies[0];
      const rows= Array.from(tbody.querySelectorAll('tr'));

      if(sortDirection[colIndex]===undefined){
        sortDirection[colIndex]='asc';
      }
      sortDirection[colIndex]=(sortDirection[colIndex]==='asc')?'desc':'asc';

      rows.sort((a,b)=>{
        const aText=a.cells[colIndex].innerText.toLowerCase();
        const bText=b.cells[colIndex].innerText.toLowerCase();

        // parse date
        if(!isNaN(Date.parse(aText))&&!isNaN(Date.parse(bText))){
          return sortDirection[colIndex]==='asc'
            ? new Date(aText)-new Date(bText)
            : new Date(bText)-new Date(aText);
        }
        // numeric
        if(!isNaN(aText)&&!isNaN(bText)){
          return sortDirection[colIndex]==='asc'
            ?(parseFloat(aText)-parseFloat(bText))
            :(parseFloat(bText)-parseFloat(aText));
        }
        // string
        if(aText<bText)return(sortDirection[colIndex]==='asc')?-1:1;
        if(aText>bText)return(sortDirection[colIndex]==='asc')?1:-1;
        return 0;
      });
      rows.forEach(r=>tbody.appendChild(r));
    }

    function filterTable(){
      const searchVal=document.getElementById('student-search').value.toLowerCase();
      const divVal=document.getElementById('division-filter').value;
      const table=document.getElementById('results-table');
      const tr=table.getElementsByTagName('tr');
      let matched=0;
      let matchedName="";
      let matchedRoll="";

      for(let i=1;i<tr.length;i++){
        const tdName= tr[i].getElementsByTagName('td')[0];
        const tdDiv = tr[i].getElementsByTagName('td')[1];
        const tdRoll= tr[i].getElementsByTagName('td')[2];
        if(tdName && tdDiv && tdRoll){
          const nameVal= tdName.textContent.toLowerCase();
          const divTxt = tdDiv.textContent.toLowerCase();
          const rollVal= tdRoll.textContent.toLowerCase();
          
          let display=true;
          if(nameVal.includes(searchVal)||divTxt.includes(searchVal)||rollVal.includes(searchVal)){
            matched++;
            matchedName= tdName.textContent;
            matchedRoll= tdRoll.textContent;
          }else{
            display=false;
          }
          if(divVal!==""){
            if(divTxt!==divVal.toLowerCase())display=false;
          }
          tr[i].style.display= display ? "":"none";
        }
      }
      if(matched===1 && searchVal!==""){
        viewResponses(matchedName, matchedRoll);
      }else{
        document.getElementById('student-responses').style.display='none';
      }
    }

    /* Show Student Responses */
    function viewResponses(stuName, rollNo){
      const student= allResults.find(e=>
        e.name.toLowerCase()===stuName.toLowerCase() && e.rollNumber===rollNo
      );
      if(!student){
        alert("Student not found.");
        return;
      }
      const respBody= document.querySelector('#responses-table tbody');
      respBody.innerHTML='';
      student.responses.forEach(r=>{
        const row= document.createElement('tr');
        row.innerHTML=`
          <td>${escapeHtml(r.question)}</td>
          <td>${escapeHtml(r.selectedAnswer)}</td>
        `;
        respBody.appendChild(row);
      });
      document.getElementById('student-responses').style.display='block';
    }

    function getQuestionsForCurrentGrade(){
      return currentGrade==='grade3'?grade3Questions:grade4Questions;
    }

    /* Score Distribution */
    function generateScoreDistributionChart(results){
      if(scoreDistributionChart)scoreDistributionChart.destroy();

      const scoreFreq={};
      results.forEach(e=>{
        scoreFreq[e.score]=(scoreFreq[e.score]||0)+1;
      });
      const labels= Object.keys(scoreFreq).sort((a,b)=>Number(a)-Number(b));
      if(labels.length===0)return;
      const data= labels.map(l=> scoreFreq[l]);

      const ctx= document.getElementById('scoreDistributionChart').getContext('2d');
      scoreDistributionChart= new Chart(ctx,{
        type:'pie',
        data:{
          labels: labels.map(l=>`Score ${l}`),
          datasets:[{
            data:data,
            backgroundColor:['#364F6B','#3FC1C9','#F5F5F5','#FC5185','#A8DADC','#E63946'],
            borderColor:'#fff',
            borderWidth:1
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{
              display:true,
              text:'Score Distribution'
            },
            legend:{
              position:'right'
            }
          }
        }
      });
    }

    /* Average Score Per Division */
    function generateAverageScorePerDivisionChart(results){
      if(averageScorePerDivisionChart)averageScorePerDivisionChart.destroy();

      const divisionScores={};
      const divisionCounts={};
      results.forEach(e=>{
        const d=e.division;
        divisionScores[d]=(divisionScores[d]||0)+ e.score;
        divisionCounts[d]=(divisionCounts[d]||0)+1;
      });
      const divisions= Object.keys(divisionScores);
      if(divisions.length===0)return;
      const avgScores= divisions.map(d=> (divisionScores[d]/divisionCounts[d]).toFixed(2));

      const ctx= document.getElementById('averageScorePerDivisionChart').getContext('2d');
      averageScorePerDivisionChart= new Chart(ctx,{
        type:'pie',
        data:{
          labels: divisions.map(d=>`Division ${d}`),
          datasets:[{
            data:avgScores,
            backgroundColor:['#364F6B','#3FC1C9','#F5F5F5','#FC5185','#A8DADC','#E63946'],
            borderColor:'#fff',
            borderWidth:1
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{
              display:true,
              text:'Average Score Per Division'
            },
            legend:{
              position:'right'
            }
          }
        }
      });
    }

    /* Response Distribution (Horizontal Scroll) */
    function generateResponseDistributionChart(results){
      responseDistributionCharts.forEach(c=>c.destroy());
      responseDistributionCharts=[];

      const questions= getQuestionsForCurrentGrade();
      const questionResponses={};

      // Tally responses
      results.forEach(e=>{
        e.responses.forEach(r=>{
          const qTxt=r.question;
          if(!questionResponses[qTxt]){
            questionResponses[qTxt]={};
            const qObj= questions.find(x=>x.question===qTxt);
            if(qObj){
              qObj.options.forEach(o=>{
                questionResponses[qTxt][o]=0;
              });
            }
          }
          const ans= r.selectedAnswer;
          questionResponses[qTxt][ans]=(questionResponses[qTxt][ans]||0)+1;
        });
      });

      const container= document.querySelector('.response-charts');
      container.innerHTML='';

      questions.forEach((qObj,i)=>{
        const qTxt=qObj.question;
        if(!questionResponses[qTxt])return;

        const responses= questionResponses[qTxt];
        const labels= Object.keys(responses);
        const data= labels.map(l=>responses[l]);

        const card= document.createElement('div');
        card.classList.add('response-card');

        const title= document.createElement('h4');
        title.textContent=`Q${i+1}: ${qTxt}`;
        card.appendChild(title);

        const canvas= document.createElement('canvas');
        canvas.id=`responseChart${i+1}`;
        card.appendChild(canvas);

        container.appendChild(card);

        const ctx= canvas.getContext('2d');
        const newChart= new Chart(ctx,{
          type:'pie',
          data:{
            labels: labels,
            datasets:[{
              data: data,
              backgroundColor:['#364F6B','#3FC1C9','#F5F5F5','#FC5185'],
              borderColor:'#fff',
              borderWidth:1
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              title:{display:false},
              legend:{position:'right'},
              tooltip:{
                callbacks:{
                  label:(context)=>{
                    const lbl= context.label||'';
                    const val= context.parsed;
                    return `${lbl}: ${val}`;
                  }
                }
              }
            }
          }
        });
        responseDistributionCharts.push(newChart);
      });
    }

    // On Load
    fetchData();
    window.onload= fetchData;
  </script>
</body>
</html>
